<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parallelize using Workflow Manager &mdash; Real-life compute cluster workflows - Parallelization  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx_lesson.css?v=0c089442" />
      <link rel="stylesheet" type="text/css" href="../../_static/term_role_formatting.css?v=4194e21c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx_rtd_theme_ext_color_contrast.css?v=8e8ea19f" />
      <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=a5c4661c" />

  
    <link rel="shortcut icon" href="../../_static/coderefinery.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=187304be"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../_static/copybutton.js?v=f281be69"></script>
        <script src="../../_static/minipres.js?v=a0d29692"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Conclusions and recommendations" href="../../conclusions/" />
    <link rel="prev" title="Parallelize using Slurm Array jobs" href="../array_jobs/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../" class="icon icon-home">
            Real-life compute cluster workflows - Parallelization
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../motivation/">Motivation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Parallelization</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../concepts/">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pitfalls/concurrency_issues/">Pitfalls - Concurrency issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pitfalls/os_side/">Pitfalls - Hardware/Server limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jupyter_to_script/">Convert a Jupyter Notebook to a Python script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallelize_using_script/">Parallelize using scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../array_jobs/">Parallelize using Slurm Array jobs</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Parallelize using Workflow Manager</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#motivation">Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#accessing-snakemake-on-an-hpc-cluster">Accessing Snakemake on an HPC cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-and-run-snakemake-workflow">Create and Run Snakemake Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#advantages-and-disadvantages">Advantages and Disadvantages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../conclusions/">Conclusions and recommendations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exercises</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../exercises/">List of exercises</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instructor-guide/">Instructor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Real-life compute cluster workflows - Parallelization</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Parallelize using Workflow Manager</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/coderefinery/TTT4HPC_parallel_workflows/blob/main/content/parallelization/parallelize_using_workflow_manager.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="parallelize-using-workflow-manager">
<h1>Parallelize using Workflow Manager<a class="headerlink" href="#parallelize-using-workflow-manager" title="Link to this heading"></a></h1>
<p>In this section, we discuss running the Iris data set example using Snakemake, a workflow manager tool.</p>
<section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Link to this heading"></a></h2>
<p>In the previous section <a class="reference internal" href="../parallelize_using_script/#parallelize-using-script"><span class="std std-ref">Parallelize using scripting</span></a>, we examined a workflow consisting of two
scripts, <code class="docutils literal notranslate"><span class="pre">preprocess.py</span></code> and <code class="docutils literal notranslate"><span class="pre">train_and_plot.py</span></code>.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">preprocess.py</span></code> script created a preprocessed Iris data set and saved it to the disk.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">train_and_plot.py</span></code> script read (number of neighbors, distance metric) parameter values as command
line arguments, loaded the preprocessed data, trained an Iris subspecies classifier, and
plotted the classifier’s boundary decisions.</p></li>
</ul>
<p>The workflow was then submitted to Slurm queue using two separate submission scripts with the following schedule</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">preprocess.py</span></code> was run first.</p></li>
<li><p>Multiple jobs of <code class="docutils literal notranslate"><span class="pre">train_and_plot.py</span></code> using different (number of neighbors, distance metric) values were submitted in parallel.</p></li>
</ul>
<p>The submission scripts (and array jobs) work well for these kind of small workflows and
are usually the go-to solution. However, if the workflow is larger and consists of
several steps, such as multiple preprocessing and postprocessing scripts, we may instead
want to use a dedicated <em>workflow manager</em> tool.</p>
<p>The general idea of a workflow manager is that each computational step in a workflow is
presented as a <em>rule</em> which takes its input as a file and writes its output to a file.
The workflow manager then</p>
<ul class="simple">
<li><p>Detects in which order the steps need to be run and which steps of the workflow can be run in parallel.</p></li>
<li><p>Checks if some of the expected result files already exist on the disk and only runs
jobs needed to produce the missing results.</p></li>
<li><p>Submits the jobs to the Slurm queue accordingly.</p></li>
</ul>
<p>While there are multiple workflow managers out there (see an
<a class="reference external" href="https://github.com/meirwah/awesome-workflow-engines">example list</a>), here we will
use a particular tool named <a class="reference external" href="https://snakemake.readthedocs.io/en/stable/">Snakemake</a>.
In Snakemake, the workflow rules are written in a <em>Snakefile</em> using a Python-like
scripting language. Snakemake itself is also written in Python. However, the computational steps
in the workflow can use any language.</p>
</section>
<section id="accessing-snakemake-on-an-hpc-cluster">
<h2>Accessing Snakemake on an HPC cluster<a class="headerlink" href="#accessing-snakemake-on-an-hpc-cluster" title="Link to this heading"></a></h2>
<p>Snakemake can be installed using <a class="reference external" href="https://pypi.org/project/snakemake/">pip</a>
along with its <a class="reference external" href="https://snakemake.github.io/snakemake-plugin-catalog/plugins/executor/slurm.html">Slurm plugin</a>.
However, since not all clusters allow users to install their own software, it is up to the cluster admins to
provide users with a recommended way to access to Snakemake. For example:</p>
<ul class="simple">
<li><p>CSC Puhti users can follow their <a class="reference external" href="https://docs.csc.fi/support/tutorials/snakemake-puhti/">official Snakemake documentation</a>.</p></li>
<li><p>Aalto Triton users can load the generic <a class="reference external" href="https://scicomp.aalto.fi/triton/apps/python/#python-distributions">scientific computing python environment module</a>: <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">scicomp-python-env</span></code></p></li>
</ul>
<p><strong>Consult your cluster’s documentation and/or contact your cluster’s administration to find the recommended way of using Snakemake.</strong></p>
</section>
<section id="create-and-run-snakemake-workflow">
<h2>Create and Run Snakemake Workflow<a class="headerlink" href="#create-and-run-snakemake-workflow" title="Link to this heading"></a></h2>
<p>In order to run the <code class="docutils literal notranslate"><span class="pre">preprocess.py</span></code> and <code class="docutils literal notranslate"><span class="pre">train_and_plot.py</span></code> as a Snakemake workflow, we do the following:</p>
<ol class="arabic simple">
<li><p>We write a <em>Snakefile</em> which defines the preprocessing and training/plotting steps as rules.</p></li>
<li><p>We write a <em>profile file</em> which defines the same requested computational resources as the Slurm batch script in section <a class="reference internal" href="../parallelize_using_script/#create-a-submission-script"><span class="std std-ref">Create a submission script</span></a>.</p></li>
</ol>
<p>The Snakefile:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameter values</span>
<span class="n">N_NEIGHBORS_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
<span class="n">METRICS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cosine&quot;</span><span class="p">,</span> <span class="s2">&quot;euclidean&quot;</span><span class="p">,</span> <span class="s2">&quot;haversine&quot;</span><span class="p">,</span> <span class="s2">&quot;l1&quot;</span><span class="p">,</span> <span class="s2">&quot;manhattan&quot;</span><span class="p">]</span>

<span class="c1"># Final output files</span>
<span class="c1"># The &quot;all&quot; rule lists all files that should ultimately be produced by the workflow</span>
<span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">expand</span><span class="p">(</span><span class="s2">&quot;results/n_neighbors=</span><span class="si">{n_neighbors}</span><span class="s2">___metric=</span><span class="si">{metric}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="n">N_NEIGHBORS_LIST</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">METRICS</span><span class="p">)</span>
        

<span class="c1"># Rule to produce an image file corresponding to a (n_neighbors, metric) combination</span>
<span class="c1"># This rule</span>
<span class="c1"># - takes as input the preprocessed data</span>
<span class="c1"># - produces an image file as output</span>
<span class="c1"># - uses an Apptainer container to run the script</span>
<span class="c1"># - logs the output of the script</span>
<span class="n">rule</span> <span class="n">train_and_plot</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s2">&quot;data/preprocessed/Iris.pkl&quot;</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="s2">&quot;results/n_neighbors=</span><span class="si">{n_neighbors}</span><span class="s2">___metric=</span><span class="si">{metric}</span><span class="s2">.png&quot;</span><span class="p">,</span>
    <span class="n">container</span><span class="p">:</span>
        <span class="s2">&quot;docker://harbor.cs.aalto.fi/aaltorse-public/coderefinery/parallel-workflow:latest&quot;</span>
    <span class="n">log</span><span class="p">:</span> 
        <span class="s2">&quot;logs/train_and_plot/n_neighbors=</span><span class="si">{n_neighbors}</span><span class="s2">___metric=</span><span class="si">{metric}</span><span class="s2">.log&quot;</span>
    <span class="n">shell</span><span class="p">:</span>
        <span class="s2">&quot;python train_and_plot.py --n_neighbors </span><span class="si">{wildcards.n_neighbors}</span><span class="s2"> --metric </span><span class="si">{wildcards.metric}</span><span class="s2"> 1&gt; </span><span class="si">{log}</span><span class="s2"> 2&gt; </span><span class="si">{log}</span><span class="s2">&quot;</span>


<span class="c1"># Rule to preprocess and create the data set</span>
<span class="n">rule</span> <span class="n">preprocess</span><span class="p">:</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="s2">&quot;data/preprocessed/Iris.pkl&quot;</span>
    <span class="n">container</span><span class="p">:</span>
        <span class="s2">&quot;docker://harbor.cs.aalto.fi/aaltorse-public/coderefinery/parallel-workflow:latest&quot;</span>
    <span class="n">log</span><span class="p">:</span> 
        <span class="s2">&quot;logs/preprocess_data/preprocess.log&quot;</span>
    <span class="n">shell</span><span class="p">:</span>
        <span class="s2">&quot;python preprocess.py 1&gt; </span><span class="si">{log}</span><span class="s2"> 2&gt; </span><span class="si">{log}</span><span class="s2">&quot;</span>
 
</pre></div>
</div>
<p>A Snakemake profile file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tell snakemake to use Slurm</span>
<span class="n">executor</span><span class="p">:</span> <span class="n">slurm</span>

<span class="c1"># Maximum number of parallel jobs</span>
<span class="n">jobs</span><span class="p">:</span> <span class="mi">10</span>  

<span class="c1"># Set number of threads for rule(s) (in Snakemake &#39;threads&#39; is equal to cpus-per-task)</span>
<span class="nb">set</span><span class="o">-</span><span class="n">threads</span><span class="p">:</span> 
  <span class="n">preprocess</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">train_and_plot</span><span class="p">:</span> <span class="mi">2</span>

<span class="c1"># Set other resources (in this case memory and time) for rule(s)</span>
<span class="c1"># Formats are described in: </span>
<span class="c1"># https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#standard-resources</span>
<span class="nb">set</span><span class="o">-</span><span class="n">resources</span><span class="p">:</span>
  <span class="n">preprocess</span><span class="p">:</span>
    <span class="n">mem</span><span class="p">:</span> <span class="mi">500</span><span class="n">MB</span>
    <span class="n">runtime</span><span class="p">:</span> <span class="mi">30</span><span class="n">m</span>
  <span class="n">train_and_plot</span><span class="p">:</span>
    <span class="n">mem</span><span class="p">:</span> <span class="mi">1</span><span class="n">GB</span>
    <span class="n">runtime</span><span class="p">:</span> <span class="mi">1</span><span class="n">h</span>
</pre></div>
</div>
<p>We run Snakemake with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span> <span class="o">--</span><span class="n">snakefile</span> <span class="n">Snakefile</span> <span class="o">--</span><span class="n">profile</span> <span class="n">profiles</span><span class="o">/</span><span class="n">slurm</span><span class="o">/</span> <span class="o">--</span><span class="n">software</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="n">method</span> <span class="n">apptainer</span>
</pre></div>
</div>
<p>What the command does:</p>
<ol class="arabic simple">
<li><p>Snakemake infers from <code class="docutils literal notranslate"><span class="pre">workflow/Snakefile</span></code> that the required input files specified in rule “All” can be created using the rule “train_and_plot” in an embarrassingly parallel manner. (Note that input files of the rule “All” are our target image files.)</p></li>
<li><p>Snakemake looks for a profile configuration file <code class="docutils literal notranslate"><span class="pre">config.yml</span></code> in the given path <code class="docutils literal notranslate"><span class="pre">profiles/slurm/</span></code>. The profile tells Snakemake to submit the jobs to Slurm and to request specific resources (cpus, memory, runtime, etc.). The resources are specified for each rule individually.</p></li>
<li><p>The option <code class="docutils literal notranslate"><span class="pre">--software-deployment-method</span></code> tells Snakemake to create the environments in which the rules are run using apptainer and conda.</p></li>
</ol>
</section>
<section id="advantages-and-disadvantages">
<h2>Advantages and Disadvantages<a class="headerlink" href="#advantages-and-disadvantages" title="Link to this heading"></a></h2>
<p>Advantages of using a workflow manager to parallelize jobs:</p>
<ul class="simple">
<li><p>Defining complete workflow using a workflow manager makes sure that scripts are submitted in correct order and in parallel if possible.</p></li>
<li><p>The workflow manager checks if some or all of the expected result files already exist and only runs jobs needed to produce the missing results.</p></li>
<li><p>Workflow managers promote reproduciblity of experiments by fixing the computational pipeline and by encouraging the use of containers and environments.</p></li>
</ul>
<p>Distadvantages:</p>
<ul class="simple">
<li><p>Not all clusters support using the workflow manager(s) of your choice out of the box. In this case, contact the cluster admin and ask what is the recommended way to use them.</p></li>
<li><p>Workflow managers are (relatively) complex tools with their own scripting syntaxes, practices, and ecosystems. Learning to use one will take time.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../array_jobs/" class="btn btn-neutral float-left" title="Parallelize using Slurm Array jobs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../conclusions/" class="btn btn-neutral float-right" title="Conclusions and recommendations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024-, The contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>