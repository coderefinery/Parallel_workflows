<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parallelize using Workflow Manager &mdash; Real-life compute cluster workflows - Parallelization  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx_lesson.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/term_role_formatting.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx_rtd_theme_ext_color_contrast.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />

  
    <link rel="shortcut icon" href="../../_static/coderefinery.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="../../_static/minipres.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Conclusions and recommendations" href="../conclusions/" />
    <link rel="prev" title="Parallelize using Slurm Array jobs" href="../array_jobs/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../" class="icon icon-home">
            Real-life compute cluster workflows - Parallelization
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The lesson</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../">Embarassingly Parallel Problems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../motivation/">Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/">Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parallelize_using_script/">Parallelize using Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../array_jobs/">Parallelize using Slurm Array jobs</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Parallelize using Workflow Manager</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../conclusions/">Conclusions and recommendations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../pitfalls/">Pitfalls when parallelising code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conclusions/">Conclusions and recommendations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instructor-guide/">Instructor’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exercises/">List of exercises</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Real-life compute cluster workflows - Parallelization</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../">Embarassingly Parallel Problems</a></li>
      <li class="breadcrumb-item active">Parallelize using Workflow Manager</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/coderefinery/content/blob/main/content/parallelization/parallelize_using_workflow_manager.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="parallelize-using-workflow-manager">
<h1>Parallelize using Workflow Manager<a class="headerlink" href="#parallelize-using-workflow-manager" title="Permalink to this heading"></a></h1>
<p>We have now seen how to parallelize code using a script which loops over parameters and
submits a job for each one correspondingly. This approach allows reusable code and generalizes
well to different types and numbers of parameters (integers, floats, text, etc.)
and their combinations. However, if the parallelized jobs are a part of a bigger workflow
with several steps, such as preprocessing and postprocessing scripts, one needs to make sure
that all the steps are run in the correct order and are correctly scheduled. For example,
training data needs to be preprocessed before starting the training script and only
those jobs that can be run in parallel should be submitted at the same time.</p>
<p>As an alternative to the submission script, we next look at running the preprocessing and the
training/plotting scripts using Snakemake, a workflow manager tool. The main idea of Snakemake
is that each computational step in a workflow is presented as a <em>rule</em> which takes its input
as a file and writes its output to a file. These rules are written in a <em>Snakefile</em> using a Python-like scripting language.
Given a Snakefile, Snakemake then detects in which order the steps need to be run and which
steps of the workflow can be run in parallel. Snakemake also checks if some of the expected
result files already exist on the disk and only runs jobs needed to produce the missing results.</p>
<p>In practice, what we need to run convert <a class="reference internal" href="../parallelize_using_script/#parallelize-using-script"><span class="std std-ref">the script approach</span></a> to a Snakemake workflow is</p>
<ol class="arabic simple">
<li><p>A snakefile which defines the computational steps (comparable to the Python/R script with loop)</p></li>
<li><p>A profile file which defines the computational resources to request from cluster (comparable to the slurm batch script)</p></li>
</ol>
<p>A Snakefile producing the same output files as the Python/R submission scripts:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Snakemake will first pull the defined container image, and then create the requested </span>
<span class="c1"># conda environments from within the container. The conda environments will be stored </span>
<span class="c1"># in the working environment. </span>

<span class="n">N_NEIGHBORS_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># [1, 2, 4, 8, 16, 32, 64]</span>
<span class="n">METRICS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cosine&quot;</span><span class="p">,</span> <span class="s2">&quot;euclidean&quot;</span><span class="p">,</span> <span class="s2">&quot;haversine&quot;</span><span class="p">,</span> <span class="s2">&quot;l1&quot;</span><span class="p">,</span> <span class="s2">&quot;manhattan&quot;</span><span class="p">]</span>

<span class="c1"># Final output files</span>
<span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">expand</span><span class="p">(</span><span class="s2">&quot;results/n_neighbors=</span><span class="si">{n_neighbors}</span><span class="s2">___metric=</span><span class="si">{metric}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="n">N_NEIGHBORS_LIST</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">METRICS</span><span class="p">)</span>


<span class="c1"># Rule to produce the final output files for parameter combinations</span>
<span class="n">rule</span> <span class="n">train_and_plot</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s2">&quot;data/preprocessed/Iris.pkl&quot;</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="s2">&quot;results/n_neighbors=</span><span class="si">{n_neighbors}</span><span class="s2">___metric=cosine.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;results/n_neighbors=</span><span class="si">{n_neighbors}</span><span class="s2">___metric=euclidean.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;results/n_neighbors=</span><span class="si">{n_neighbors}</span><span class="s2">___metric=haversine.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;results/n_neighbors=</span><span class="si">{n_neighbors}</span><span class="s2">___metric=l1.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;results/n_neighbors=</span><span class="si">{n_neighbors}</span><span class="s2">___metric=manhattan.png&quot;</span><span class="p">,</span>
    <span class="n">container</span><span class="p">:</span>
        <span class="s2">&quot;docker://harbor.cs.aalto.fi/aaltorse-public/coderefinery/parallel-workflow:latest&quot;</span>
    <span class="n">log</span><span class="p">:</span> 
        <span class="s2">&quot;logs/train_and_plot/n_neighbors=</span><span class="si">{n_neighbors}</span><span class="s2">.log&quot;</span>
    <span class="n">shell</span><span class="p">:</span>
        <span class="s2">&quot;python train_and_plot.py --n_neighbors </span><span class="si">{wildcards.n_neighbors}</span><span class="s2"> 1&gt; </span><span class="si">{log}</span><span class="s2"> 2&gt; </span><span class="si">{log}</span><span class="s2">&quot;</span>


<span class="c1"># Rule to preprocess the data</span>
<span class="n">rule</span> <span class="n">preprocess</span><span class="p">:</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="s2">&quot;data/preprocessed/Iris.pkl&quot;</span>
    <span class="n">container</span><span class="p">:</span>
        <span class="s2">&quot;docker://harbor.cs.aalto.fi/aaltorse-public/coderefinery/parallel-workflow:latest&quot;</span>
    <span class="n">log</span><span class="p">:</span> 
        <span class="s2">&quot;logs/preprocess_data/preprocess.log&quot;</span>
    <span class="n">shell</span><span class="p">:</span>
        <span class="s2">&quot;python preprocess.py 1&gt; </span><span class="si">{log}</span><span class="s2"> 2&gt; </span><span class="si">{log}</span><span class="s2">&quot;</span>
 
</pre></div>
</div>
<p>A profile file defining the same computational resources as the</p>
<p>Run Snakemake with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span> <span class="o">--</span><span class="n">snakefile</span> <span class="n">Snakefile</span> <span class="o">--</span><span class="n">profile</span> <span class="n">profiles</span><span class="o">/</span><span class="n">slurm</span><span class="o">/</span> <span class="o">--</span><span class="n">software</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="n">method</span> <span class="n">apptainer</span>

</pre></div>
</div>
<p>What happens:</p>
<ol class="arabic simple">
<li><p>Snakemake infers from <code class="docutils literal notranslate"><span class="pre">workflow/Snakefile</span></code> that the required input files specified in rule “All” can be created using the rule “plot_decision_boundaries” in an embarassingly parallel manner. (Note that input files of the rule “All” are our target output files.)</p></li>
<li><p>Snakemake looks for profile configuration file <code class="docutils literal notranslate"><span class="pre">config.yml</span></code> in the given path <code class="docutils literal notranslate"><span class="pre">profiles/slurm/</span></code>. The profile tells Snakemake to submit the jobs to Slurm and to request specific resources (cpus, memory, runtime, etc.). The resources can be specified for each rule individually.</p></li>
<li><p>The option <code class="docutils literal notranslate"><span class="pre">--software-deployment-method</span></code> tells Snakemake to create the environments in which the rules are run using apptainer and conda.</p></li>
</ol>
<p>(4. The option <code class="docutils literal notranslate"><span class="pre">--use-conda</span></code> tells Snakemake to look for Conda/Mamba environments in <code class="docutils literal notranslate"><span class="pre">.snakemake/conda/</span></code> for the rule “plot_decision_boundaries”. These environments will be created if they do not exist yet.)</p>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this heading"></a></h2>
<p>In summary, advantages and disadvantages of using a workflow manager to parallelize jobs:</p>
<ul class="simple">
<li><p>Defining complete workflow using a workflow manager makes sure that scripts are submitted in correct order and in parallel if possible.</p></li>
<li><p>A workflow manager checks if some or all of the expected result files already exist and only runs jobs needed to produce the missing results.</p></li>
</ul>
<ul class="simple">
<li><p>A workflow manager is yet another, relatively complex, tool to learn and will take time.</p></li>
<li><p>Not all clusters support using the workflow manager(s) of your choice out of the box. In this case, contact the cluster admin and ask what is the recommended way to use them.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../array_jobs/" class="btn btn-neutral float-left" title="Parallelize using Slurm Array jobs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../conclusions/" class="btn btn-neutral float-right" title="Conclusions and recommendations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024-, The contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>