<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Common issues &mdash; Real-life compute cluster workflows - Parallelization  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx_lesson.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/term_role_formatting.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx_rtd_theme_ext_color_contrast.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />

  
    <link rel="shortcut icon" href="../../_static/coderefinery.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="../../_static/minipres.js"></script>
        <script src="../../_static/tabs.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Conclusions and recommendations" href="../../conclusions/" />
    <link rel="prev" title="Pitfalls when parallelising code" href="../" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../" class="icon icon-home">
            Real-life compute cluster workflows - Parallelization
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The lesson</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../parallelization/">Embarassingly Parallel Problems</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Pitfalls when parallelising code</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Common issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#concurrency-issues">Concurrency issues</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../conclusions/">Conclusions and recommendations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instructor-guide/">Instructor’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exercises/">List of exercises</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Real-life compute cluster workflows - Parallelization</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../">Pitfalls when parallelising code</a></li>
      <li class="breadcrumb-item active">Common issues</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/coderefinery/content/blob/main/content/pitfalls/common_issues.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="common-issues">
<h1>Common issues<a class="headerlink" href="#common-issues" title="Permalink to this heading"></a></h1>
<p>By running several computations in parallel we place a few more constraints on what we can
or cannot do, resulting in concurrency issues. In a non parallel situation we commonly
do not need to pay attention to what the resources are accessed by the code. This is different
when the code runs in parallel. There are also additional considerations as to overheads
which need to be taken into consideration.</p>
<section id="concurrency-issues">
<h2>Concurrency issues<a class="headerlink" href="#concurrency-issues" title="Permalink to this heading"></a></h2>
<p>Let’s take the following piece of code:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-0-Ug==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-0-UHl0aG9u" class="sphinx-tabs-panel group-tab" id="panel-0-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">processing</span> <span class="kn">import</span> <span class="n">load_and_preprocess_data</span><span class="p">,</span> <span class="n">calculate</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">load_and_preprocess_data</span><span class="p">()</span>
<span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calculate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s2">&quot;results&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-Ug==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">processing</span><span class="p">)</span>

<span class="c1"># Load and preprocess data</span>
<span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">load_and_preprocess_data</span><span class="p">()</span>

<span class="c1"># Initialize an empty list to store results</span>
<span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span>

<span class="c1"># Loop through each element in data and calculate results</span>
<span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">res</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="n">i</span><span class="p">]])</span>
<span class="p">}</span>

<span class="c1"># Save results using serialize</span>
<span class="nf">serialize</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="o">=</span><span class="s">&quot;results&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>which we have identified as embarassingly parallel code and converted to the following:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-1-Ug==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-1-UHl0aG9u" class="sphinx-tabs-panel group-tab" id="panel-1-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">processing</span> <span class="kn">import</span> <span class="n">load_and_preprocess_data</span><span class="p">,</span> <span class="n">calculate</span>


<span class="k">def</span> <span class="nf">append_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a result to the result file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result_file</span> <span class="o">=</span> <span class="s2">&quot;results.pkl&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">result_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">allres</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="c1"># The file does not yet exist</span>
        <span class="n">allres</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">allres</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">result_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">allres</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="c1"># Assuming load_and_preprocess_data and calculate are functions from processing library</span>

<span class="c1"># Load and preprocess data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">load_and_preprocess_data</span><span class="p">()</span>

<span class="c1"># Get index from command line argument (assuming this Python script is called with the index as an argument)</span>
<span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Calculate result</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">calculate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

<span class="c1"># Append result to the result file</span>
<span class="n">append_result</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-Ug==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">processing</span><span class="p">)</span>

<span class="n">append_result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">result_file</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;results.rds&quot;</span>
<span class="w">  </span><span class="nf">if </span><span class="p">(</span><span class="nf">file.exists</span><span class="p">(</span><span class="n">result_file</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">allres</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">readRDS</span><span class="p">(</span><span class="n">result_file</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">allres</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">allres</span><span class="p">[[</span><span class="nf">as.character</span><span class="p">(</span><span class="n">index</span><span class="p">)]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">result</span>
<span class="w">  </span><span class="nf">writeRDS</span><span class="p">(</span><span class="n">allres</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result_file</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Assuming load_and_preprocess_data and calculate are functions from processing library</span>

<span class="c1"># Load and preprocess data</span>
<span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">load_and_preprocess_data</span><span class="p">()</span>

<span class="c1"># Get index from command line argument (assuming this R script is called with the index as an argument)</span>
<span class="n">args</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">commandArgs</span><span class="p">(</span><span class="n">trailingOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">index</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">1</span><span class="p">])</span>

<span class="c1"># Calculate result</span>
<span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="n">index</span><span class="p">]])</span>

<span class="c1"># Append result to the result file</span>
<span class="nf">append_result</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>Our <code class="docutils literal notranslate"><span class="pre">append_result</span></code> function either creates the results file, if it does not exist yet, or, if
it does, it reads in the result array. We run this function several times via an <code class="docutils literal notranslate"><span class="pre">sarray</span></code> job.
This can work fine. However, it can also lead to errors, and worst case invalid results.
The problem arises because we don’t know the point in time at which the result file is opened
and written to. Likely some jobs will fail with an error thrown, when two processes try to
simultaneously write to the same file, or that some try to read from the file while it is
written to. More inconvenient could be suspiciously missing results in the results file, due to
two reads of the file, which leads to conflicting writes, where one result is simply lost.
Or, we could end up with an entirely corrupt file, when two jobs write simultaneously and the
filesystem doesn’t complain about it…</p>
<p>So, an important thing to keep in mind is to have the parallelized code really be independent
of other instances. In most cases this means, using index specific output files and having a
“collection script” that combines the data after the jobs are complete. This can even be done with slurm internal methods:</p>
<div class="highlight-slurm notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="kp">#SBATCH --job-name=collection_job</span>
<span class="kp">#SBATCH --dependency=afterok:your_array_job_id</span>

<span class="c1"># run your collection script</span>
python<span class="w"> </span>collection.py
</pre></div>
</div>
<p>The above case would then become something like:</p>
<p>Calculation script:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-2-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-2-Ug==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-2-UHl0aG9u" class="sphinx-tabs-panel group-tab" id="panel-2-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">processing</span> <span class="kn">import</span> <span class="n">load_and_preprocess_data</span><span class="p">,</span> <span class="n">calculate</span>

<span class="c1"># Assuming load_and_preprocess_data and calculate are functions from processing library</span>

<span class="c1"># Load and preprocess data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">load_and_preprocess_data</span><span class="p">()</span>

<span class="c1"># Get index from command line argument (assuming this Python script is called with the index as an argument)</span>
<span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">result_folder</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="c1"># Calculate result</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">calculate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

<span class="c1"># Write the result</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">result_folder</span><span class="si">}</span><span class="s2">/result_</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-Ug==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">processing</span><span class="p">)</span>

<span class="c1"># Assuming load_and_preprocess_data and calculate are functions from processing library</span>

<span class="c1"># Load and preprocess data</span>
<span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">load_and_preprocess_data</span><span class="p">()</span>

<span class="c1"># Get index from command line argument (assuming this R script is called with the index as an argument)</span>
<span class="n">args</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">commandArgs</span><span class="p">(</span><span class="n">trailingOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">index</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">1</span><span class="p">])</span>
<span class="n">folder</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="m">2</span><span class="p">]</span>
<span class="c1"># Calculate result</span>
<span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="n">index</span><span class="p">]])</span>

<span class="c1"># Append result to the result file</span>
<span class="nf">writeRDS</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;%s/result_%i&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">folder</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">))</span>
</pre></div>
</div>
</div></div>
<p>Submission:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-3-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-3-Ug==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-3-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-3-UHl0aG9u" class="sphinx-tabs-panel group-tab" id="panel-3-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-slurm notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="kp">#SBATCH --job-name=long_job</span>
<span class="kp">#SBATCH --array=1-10</span>

<span class="c1"># We assume, that singularity runs out of the box on your cluster, if not, you will have to</span>
<span class="c1"># add a command here that makes the singularity command available on your cluster</span>

<span class="c1"># Define a Result directory, since this should not ollide with others we use the slurm job ID</span>
<span class="c1"># To distinguish between different runs</span>
<span class="nv">RESULTDIR</span><span class="o">=</span><span class="s2">&quot;results_</span><span class="nv">$SLURM_JOB_ID</span><span class="s2">&quot;</span>

<span class="c1"># create the result dir if it does not exist</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$RESULTDIR</span>

<span class="c1"># Example command: replace with your actual command</span>
singularity<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>python_container<span class="w"> </span>python<span class="w"> </span>train_and_plot.py<span class="w"> </span><span class="nv">$SLURM_ARRAY_TASK_ID</span><span class="w"> </span><span class="nv">$RESULTDIR</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-Ug==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-3-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-slurm notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="kp">#SBATCH --job-name=long_job</span>
<span class="kp">#SBATCH --array=1-10</span>

<span class="c1"># We assume, that python3 runs out of the box on your cluster, if not, you will have to</span>
<span class="c1"># add a command here that makes the python3 command available on your cluster</span>

<span class="c1"># Define a Result directory, since this should not ollide with others we use the slurm job ID</span>
<span class="c1"># To distinguish between different runs</span>
<span class="nv">RESULTDIR</span><span class="o">=</span><span class="s2">&quot;results_</span><span class="nv">$SLURM_JOB_ID</span><span class="s2">&quot;</span>

<span class="c1"># create the result dir if it does not exist</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$RESULTDIR</span>

<span class="c1"># Example command: replace with your actual command</span>
Rscript<span class="w"> </span>your_example.r<span class="w"> </span><span class="nv">$SLURM_ARRAY_TASK_ID</span><span class="w"> </span><span class="nv">$RESULTDIR</span>
</pre></div>
</div>
</div></div>
<p>CollectionScript:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-4-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-4-Ug==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-4-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-4-UHl0aG9u" class="sphinx-tabs-panel group-tab" id="panel-4-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">folder_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">data_array</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;result_&quot;</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data_array</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-Ug==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-4-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">args</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">commandArgs</span><span class="p">(</span><span class="n">trailingOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">folder_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>

<span class="n">data_array</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span>
<span class="n">files</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list.files</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>

<span class="nf">for </span><span class="p">(</span><span class="n">filename</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="nf">if </span><span class="p">(</span><span class="nf">grepl</span><span class="p">(</span><span class="s">&quot;^result_[0-9]+\\.rds$&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">sub</span><span class="p">(</span><span class="s">&quot;^result_([0-9]+)\\.rds$&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\\1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">))</span>
<span class="w">    </span><span class="n">file_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span>
<span class="w">    </span><span class="n">data_array</span><span class="p">[[</span><span class="n">index</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">readRDS</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Write the data array to a result file</span>
<span class="n">result_file_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;result.rds&quot;</span><span class="p">)</span>
<span class="nf">saveRDS</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span><span class="w"> </span><span class="n">result_file_path</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>Submission for collection:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-5-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-5-Ug==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-5-Ug==" name="Ug==" role="tab" tabindex="-1">R</button></div><div aria-labelledby="tab-5-UHl0aG9u" class="sphinx-tabs-panel group-tab" id="panel-5-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-slurm notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="kp">#SBATCH --job-name=collection_job</span>
<span class="kp">#SBATCH --dependency=afterok:your_array_job_id</span>

<span class="nv">RESULTDIR</span><span class="o">=</span><span class="s2">&quot;results_your_array_job_id&quot;</span>
<span class="c1"># run your collection script</span>
python<span class="w"> </span>collection.py<span class="w"> </span>RESULTDIR
</pre></div>
</div>
</div><div aria-labelledby="tab-5-Ug==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-5-Ug==" name="Ug==" role="tabpanel" tabindex="0"><div class="highlight-slurm notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="kp">#SBATCH --job-name=collection_job</span>
<span class="kp">#SBATCH --dependency=afterok:your_array_job_id</span>

<span class="nv">RESULTDIR</span><span class="o">=</span><span class="s2">&quot;results_your_array_job_id&quot;</span>
<span class="c1"># run your collection script</span>
Rscript<span class="w"> </span>collection.r<span class="w"> </span><span class="nv">$RESULTDIR</span>
</pre></div>
</div>
</div></div>
<p>While the above example might be a bit artificial, we once had a user, who had a more complex
workflow, which needed to call scripts from several languages, and used files to communicate
between the different runs. However, these temporary files were the same for all runs, which
lead to results that were completely unreliable. The user was lucky that some of the runs
actually errored out with a very strange error and they had to re-run all of their runs as
none were reliable. And these things can even be hidden within some libraries, which expect to
only be used in one process at a time and e.g. write some temporary files to home folders.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../" class="btn btn-neutral float-left" title="Pitfalls when parallelising code" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../conclusions/" class="btn btn-neutral float-right" title="Conclusions and recommendations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024-, The contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>